{% extends "layouts/base.html" %}

{% block title %}Formulario de Adopción{% endblock %}

{% block stylesheets %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/formulario.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/validation.css') }}">
{% endblock %}

{% block navbar %}
<!-- Header personalizado para formulario de adopción -->
<header class="topbar">
    <div class="topbar-inner">
        <div class="brand">
            <i class="fa-solid fa-paw"></i> Adopt Me
        </div>
        <nav class="nav" aria-label="Navegación principal">
            <a href="/"><i class="fa-solid fa-house"></i> Inicio</a>
            <a href="/adopcion"><i class="fa-solid fa-dog"></i> Mascotas</a>
            <a href="/fundaciones"><i class="fa-solid fa-hand-holding-heart"></i> Fundaciones</a>
        </nav>
        <div class="user" title="Perfil">
            <i class="fa-regular fa-user"></i>
        </div>
    </div>
</header>
{% endblock %}

{% block background_effects %}
{% include 'components/paws.html' %}
{% endblock %}

{% block content %}
<main>
    <section class="form-container">
        <h1 class="form-title" id="form-title">Formulario de Adopción</h1>
        <p class="form-desc">Completa tus datos y cuéntanos por qué deseas adoptar. Nos pondremos en contacto contigo
            pronto.</p>
        <form id="adoptionForm" method="POST" action="/formulario" data-validate novalidate>
            
            <div class="form-row">
                <div class="form-field-container">
                    {% include 'components/form-field.html' with {
                        'name': 'nombre',
                        'type': 'text',
                        'label': 'Nombre Completo',
                        'placeholder': 'Tu nombre y apellidos',
                        'validation': 'required|name',
                        'required': true
                    } %}
                </div>
                <div class="form-field-container">
                    {% include 'components/form-field.html' with {
                        'name': 'email',
                        'type': 'email',
                        'label': 'Correo Electrónico',
                        'placeholder': 'tucorreo@ejemplo.com',
                        'validation': 'required|email',
                        'required': true
                    } %}
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-field-container">
                    {% include 'components/form-field.html' with {
                        'name': 'telefono',
                        'type': 'tel',
                        'label': 'Teléfono',
                        'placeholder': '(+57) 300 000 0000',
                        'validation': 'required|phone',
                        'required': true
                    } %}
                </div>
                <div class="form-field-container">
                    {% include 'components/form-field.html' with {
                        'name': 'direccion',
                        'type': 'text',
                        'label': 'Dirección',
                        'placeholder': 'Calle 123 #45-67, Barrio, Ciudad',
                        'validation': 'required|minLength:5',
                        'required': true
                    } %}
                </div>
            </div>
            
            {% include 'components/form-field.html' with {
                'name': 'ocupacion',
                'type': 'text',
                'label': 'Ocupación',
                'placeholder': '¿A qué te dedicas?',
                'validation': 'required|minLength:2',
                'required': true
            } %}
            
            {% include 'components/form-select.html' with {
                'name': 'vivienda',
                'label': 'Tipo de Vivienda',
                'validation': 'required',
                'required': true,
                'options': [
                    {'value': 'casa', 'label': 'Casa'},
                    {'value': 'apartamento', 'label': 'Apartamento'},
                    {'value': 'finca', 'label': 'Finca'},
                    {'value': 'otro', 'label': 'Otro'}
                ]
            } %}
            
            {% include 'components/form-select.html' with {
                'name': 'mascotas',
                'label': '¿Tienes otras mascotas?',
                'validation': 'required',
                'required': true,
                'options': [
                    {'value': 'no', 'label': 'No'},
                    {'value': 'perro', 'label': 'Sí, perro(s)'},
                    {'value': 'gato', 'label': 'Sí, gato(s)'},
                    {'value': 'otros', 'label': 'Sí, otros'}
                ]
            } %}
            
            {% include 'components/form-textarea.html' with {
                'name': 'motivo',
                'label': '¿Por qué deseas adoptar?',
                'placeholder': 'Cuéntanos sobre tu hogar, tu tiempo disponible y por qué te gustaría adoptar.',
                'validation': 'required|minLength:10',
                'required': true,
                'rows': 4,
                'maxlength': 500
            } %}
            
            {% include 'components/form-checkbox.html' with {
                'name': 'acepta_terminos',
                'label': 'Acepto los términos y condiciones de adopción',
                'validation': 'required',
                'required': true
            } %}
            
            <div class="form-actions">
                <a class="btn btn-ghost" href="/adopcion">
                    <i class="fa-solid fa-arrow-left"></i> Volver
                </a>
                <button type="submit" class="btn btn-primary submit-btn" disabled>
                    <i class="fa-solid fa-paper-plane"></i> Enviar Solicitud
                </button>
            </div>
        </form>
    </section>
</main>

<!-- Incluir componentes -->
{% include 'components/boton_animado.html' %}
{% include 'components/notificacion_exitosa.html' %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='JS/validation.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const pet = params.get('pet');
        if (pet) {
            const title = document.getElementById('form-title');
            if (title) title.textContent = `Formulario de Adopción – ${pet}`;
        }
        // Configurar validación estricta antes de la animación
        const form = document.querySelector('form');
        const submitBtn = document.querySelector('button[type="submit"]');

        if (form && submitBtn) {
            // Función para validar completamente el formulario
            function validateForm() {
                // Verificar validez nativa del formulario
                if (!form.checkValidity()) {
                    return false;
                }

                // Validaciones adicionales personalizadas
                const requiredFields = form.querySelectorAll('[required]');
                for (let field of requiredFields) {
                    if (!field.value.trim()) {
                        return false;
                    }

                    // Validación específica por tipo de campo
                    if (field.type === 'email' && !field.value.includes('@')) {
                        return false;
                    }

                    if (field.type === 'tel' && field.value.length < 8) {
                        return false;
                    }

                    if (field.tagName === 'TEXTAREA' && field.value.trim().length < 10) {
                        return false;
                    }
                }

                return true;
            }

            // Función para limpiar todos los campos del formulario
            function clearFormFields() {
                // Limpiar todos los inputs de texto, email, tel
                const inputs = form.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"]');
                inputs.forEach(input => {
                    input.value = '';
                });

                // Limpiar selects (volver a la primera opción vacía)
                const selects = form.querySelectorAll('select');
                selects.forEach(select => {
                    select.selectedIndex = 0; // Volver a "Selecciona una opción"
                });

                // Limpiar textareas
                const textareas = form.querySelectorAll('textarea');
                textareas.forEach(textarea => {
                    textarea.value = '';
                });

                // Remover clases de validación para que no aparezcan mensajes de error
                form.classList.remove('was-validated');

                // Opcional: Enfocar el primer campo para facilitar el siguiente uso
                const firstInput = form.querySelector('input');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 300);
                }

                console.log('Formulario limpiado completamente');
            }

            // Interceptar TODOS los eventos del botón para validar primero
            submitBtn.addEventListener('click', (e) => {
                // Validación estricta antes de cualquier acción
                if (!validateForm()) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    // Mostrar errores de validación
                    form.classList.add('was-validated');
                    form.reportValidity();

                    // Prevenir cualquier animación
                    return false;
                }

                // Si pasa la validación, permitir que la animación continúe
                console.log('Formulario válido, iniciando animación...');
            }, true); // Usar capture para ejecutar primero

            // Manejar el envío del formulario con notificación
            form.addEventListener('submit', async (e) => {
                e.preventDefault(); // Siempre prevenir el envío real

                if (!validateForm()) {
                    form.classList.add('was-validated');
                    form.reportValidity();
                    return false;
                }

                // Si es válido, mostrar notificación de éxito después de la animación
                console.log('Formulario válido, preparando notificación...');

                // Esperar un momento para que el componente esté disponible
                setTimeout(async () => {
                    await showSuccessModal(
                        '¡Formulario Enviado Correctamente!',
                        'Tu solicitud de adopción ha sido recibida. Nos pondremos en contacto contigo muy pronto para continuar con el proceso.',
                        {
                            isForm: true, // Modo específico para formularios
                            buttonText: '¡Perfecto!'
                        }
                    );

                    // Limpiar todos los campos del formulario después de cerrar el modal
                    clearFormFields();

                    // Opcional: Redirigir después de cerrar la notificación
                    // window.location.href = '/adopcion';
                }, 100);
            });
        }
    });
</script>
{% endblock %}