{% extends "layouts/base.html" %}

{% block title %}Registro Usuario - Adopt Me{% endblock %}

{% block stylesheets %}
<link href="{{ url_for('static', filename='css/registro-usuario.css') }}" rel="stylesheet" />
<link href="{{ url_for('static', filename='css/validation.css') }}" rel="stylesheet" />
{% endblock %}

{% block navbar %}
<!-- No navbar en registro -->
{% endblock %}

{% block footer %}
<!-- No footer en registro -->
{% endblock %}

{% block background_effects %}
{% include 'components/particles.html' %}
{% include 'components/paws.html' %}
{% endblock %}

{% block content %}
<div class="register-container">
    <div class="register-card">
        {% include 'components/university_logo.html' %}


            <h1 class="register-title">Crear Cuenta</h1>

            <form id="registrationForm" method="POST" action="{{ url_for('Registro_Usuario') }}" data-validate novalidate>
                
                {% include 'components/form-field.html' with {
                    'name': 'nombre',
                    'type': 'text',
                    'label': 'Nombre Completo',
                    'placeholder': 'Tu nombre y apellidos',
                    'validation': 'required|name',
                    'icon': 'fa-user',
                    'required': true,
                    'autocomplete': 'name'
                } %}

                {% include 'components/form-field.html' with {
                    'name': 'email',
                    'type': 'email',
                    'label': 'Correo Electrónico',
                    'placeholder': 'ejemplo@correo.com',
                    'validation': 'required|email',
                    'icon': 'fa-envelope',
                    'required': true,
                    'autocomplete': 'email'
                } %}

                {% include 'components/form-field.html' with {
                    'name': 'telefono',
                    'type': 'tel',
                    'label': 'Teléfono',
                    'placeholder': '+57 300 000 0000',
                    'validation': 'phone',
                    'icon': 'fa-phone',
                    'autocomplete': 'tel'
                } %}

                {% include 'components/form-field.html' with {
                    'name': 'password',
                    'type': 'password',
                    'label': 'Contraseña',
                    'placeholder': 'Mínimo 6 caracteres',
                    'validation': 'required|password',
                    'icon': 'fa-lock',
                    'required': true,
                    'autocomplete': 'new-password'
                } %}

                <button type="submit" class="register-btn submit-btn" disabled>
                    <i class="fas fa-user-plus"></i>
                    <span>Crear Cuenta</span>
                </button>
            </form>

            <div class="login-link">
                <a href="{{ url_for('Iniciar_Sesion') }}">¿Ya tienes cuenta? Inicia sesión</a>
                <div class="admin-link">
                    ¿O eres administrador? <a href="{{ url_for('Registro_Administrador') }}" class="admin-register-link">Regístrate</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Incluir componente de notificación -->
{% include 'components/notificacion_exitosa.html' %}

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='JS/validation.js') }}"></script>
<script>
        (function () {
            const form = document.querySelector('form');
            const inputs = form.querySelectorAll('.form-input');
            const submitBtn = document.getElementById('submitBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const btnText = document.getElementById('btnText');

            // Elementos de validación
            const userInput = document.getElementById('user');
            const passwordInput = document.getElementById('password');
            const emailInput = document.getElementById('email');
            const email2Input = document.getElementById('email2');
            const passwordStrength = document.querySelector('.password-strength');
            const passwordStrengthFill = document.querySelector('.password-strength-fill');

            // Funciones de validación
            function validateUser() {
                const value = userInput.value;
                const validation = document.getElementById('userValidation');

                if (value.length < 3 && value.length > 0) {
                    userInput.classList.add('invalid');
                    userInput.classList.remove('valid');
                    validation.textContent = 'El usuario debe tener al menos 3 caracteres';
                    validation.classList.add('show');
                    return false;
                } else if (value.length >= 3) {
                    userInput.classList.add('valid');
                    userInput.classList.remove('invalid');
                    validation.classList.remove('show');
                    return true;
                } else {
                    userInput.classList.remove('valid', 'invalid');
                    validation.classList.remove('show');
                    return false;
                }
            }

            function validatePassword() {
                const value = passwordInput.value;
                const validation = document.getElementById('passwordValidation');

                if (value.length === 0) {
                    passwordStrength.classList.remove('show');
                    passwordInput.classList.remove('valid', 'invalid');
                    validation.classList.remove('show');
                    return false;
                }

                passwordStrength.classList.add('show');

                // Calcular fortaleza
                let strength = 0;
                if (value.length >= 6) strength += 25;
                if (value.length >= 8) strength += 25;
                if (/[A-Z]/.test(value)) strength += 25;
                if (/[0-9]/.test(value)) strength += 25;

                passwordStrengthFill.style.width = strength + '%';

                if (value.length < 6) {
                    passwordInput.classList.add('invalid');
                    passwordInput.classList.remove('valid');
                    validation.textContent = 'La contraseña debe tener al menos 6 caracteres';
                    validation.classList.add('show');
                    return false;
                } else {
                    passwordInput.classList.add('valid');
                    passwordInput.classList.remove('invalid');
                    validation.classList.remove('show');
                    return true;
                }
            }
            function validateEmail() {
                const value = emailInput.value;
                const validation = document.getElementById('emailValidation');
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                if (value.length === 0) {
                    emailInput.classList.remove('valid', 'invalid');
                    validation.classList.remove('show');
                    return false;
                }

                if (!emailRegex.test(value)) {
                    emailInput.classList.add('invalid');
                    emailInput.classList.remove('valid');
                    validation.textContent = 'Ingresa un correo electrónico válido';
                    validation.classList.add('show');
                    return false;
                } else {
                    emailInput.classList.add('valid');
                    emailInput.classList.remove('invalid');
                    validation.classList.remove('show');
                    return true;
                }
            }

            function validateEmailConfirmation() {
                const email = emailInput.value;
                const email2 = email2Input.value;
                const validation = document.getElementById('email2Validation');

                if (email2.length === 0) {
                    email2Input.classList.remove('valid', 'invalid');
                    validation.classList.remove('show');
                    return false;
                }

                if (email !== email2) {
                    email2Input.classList.add('invalid');
                    email2Input.classList.remove('valid');
                    validation.textContent = 'Los correos electrónicos no coinciden';
                    validation.classList.add('show');
                    email2Input.setCustomValidity('Los correos no coinciden');
                    return false;
                } else {
                    email2Input.classList.add('valid');
                    email2Input.classList.remove('invalid');
                    validation.classList.remove('show');
                    email2Input.setCustomValidity('');
                    return true;
                }
            }

            // Event listeners
            userInput.addEventListener('input', validateUser);
            passwordInput.addEventListener('input', validatePassword);
            emailInput.addEventListener('input', () => {
                validateEmail();
                validateEmailConfirmation();
            });
            email2Input.addEventListener('input', validateEmailConfirmation);

            // Efectos de focus para los iconos
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    const icon = input.nextElementSibling;
                    if (icon && icon.classList.contains('input-icon')) {
                        icon.style.color = '#667eea';
                    }
                });

                input.addEventListener('blur', () => {
                    const icon = input.nextElementSibling;
                    if (icon && icon.classList.contains('input-icon') && !input.value) {
                        icon.style.color = '#a0aec0';
                    }
                });
            });

            // Función para validar todo el formulario
            function isFormValid() {
                const isUserValid = validateUser();
                const isPasswordValid = validatePassword();
                const isEmailValid = validateEmail();
                const isEmail2Valid = validateEmailConfirmation();
                
                return isUserValid && isPasswordValid && isEmailValid && isEmail2Valid;
            }

            // Submit del formulario - UN SOLO EVENT LISTENER
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                // Validar todos los campos
                if (isFormValid()) {
                    // Mostrar loading
                    submitBtn.disabled = true;
                    loadingSpinner.style.display = 'inline-block';
                    btnText.textContent = 'Creando cuenta...';

                    // Simular proceso de registro (2 segundos)
                    setTimeout(() => {
                        // Ocultar spinner
                        loadingSpinner.style.display = 'none';
                        btnText.textContent = 'Crear Cuenta';
                        submitBtn.disabled = false;
                        
                        // Mostrar modal de éxito y esperar confirmación
                        showSuccessModal(
                            `¡Bienvenido a Adopt Me, ${userInput.value}!`,
                            `Tu cuenta ha sido creada exitosamente. Ahora puedes comenzar a buscar a tu compañero peludo ideal y darle el hogar que se merece.`
                        ).then(() => {
                            // Esta parte se ejecuta DESPUÉS de hacer clic en "Aceptar"
                            console.log('Usuario confirmó la creación de cuenta');
                            
                            // Redirigir a la página de iniciar sesión
                            window.location.href = '/iniciar-sesion';
                        });
                        
                        // Aquí es donde se guardaría en la base de datos
                        console.log('Datos del formulario:', {
                            usuario: userInput.value,
                            email: emailInput.value,
                            timestamp: new Date().toISOString()
                        });
                    }, 2000);
                } else {
                    // Enfocar el primer campo inválido
                    const firstInvalid = form.querySelector('.form-input.invalid');
                    if (firstInvalid) {
                        firstInvalid.focus();
                    }
                }
            });

            // Efecto de escritura en el título
            const title = document.querySelector('.register-title');
            const titleText = title.textContent;
            title.textContent = '';

            setTimeout(() => {
                let i = 0;
                const typeWriter = () => {
                    if (i < titleText.length) {
                        title.textContent += titleText.charAt(i);
                        i++;
                        setTimeout(typeWriter, 100);
                    }
                };
                typeWriter();
            }, 800);
        })();
</script>
{% endblock %}